/*!
****************************************************************************************************
* 文件名称：drvmanager-dac.c
* 功能简介：该文件是驱动管理器DAC驱动模块的实现源文件
* 文件作者：HQHP
* 创建日期：2023-08-08
* 版权声明：All Rights Reserved.
****************************************************************************************************
*/
#include "stm32f4xx.h"
#include "drvmanager.h"

/*!
****************************************************************************************************
* 常量定义
****************************************************************************************************
*/
#define DAC_CMD_CH_A 0x10 // 写更新通道A
#define DAC_CMD_CH_B 0x24 // 写更新通道B

// DAC8552相关常量
#define SAMPLE_R			   (124.0) // 取样电阻，单位：Ω
#define VREFIN				   (2435)  // 参考电压，单位：mV
#define DAC_VREF			   3.3f	   // DAC参考电压(V)
#define DAC_RESOLUTION		   65535   // DAC分辨率(16位)
#define DAC_VOLTAGE_TO_CURRENT 4.848f  // 电压到电流转换系数(mA/V)

/*!
****************************************************************************************************
* 类型定义
****************************************************************************************************
*/

/*!
****************************************************************************************************
* 全局变量
****************************************************************************************************
*/

/*!
****************************************************************************************************
* 本地声明
****************************************************************************************************
*/

/*!
****************************************************************************************************
* 接口函数
****************************************************************************************************
*/
/*!
****************************************************************************************************
* 功能描述：该方法用于初始化DAC驱动模块
* 注意事项：NA
* 输入参数：NA
* 输出参数：NA
* 返回参数：NA
****************************************************************************************************
*/
void DRVMGR_DACInit(void)
{
	/* NOTHING TO DO */
}

/*!
****************************************************************************************************
* 功能描述：该方法用于执行DAC驱动模块周期事务
* 注意事项：NA
* 输入参数：NA
* 输出参数：NA
* 返回参数：NA
****************************************************************************************************
*/
void DRVMGR_DACHandle(void)
{
	/* NOTHING TO DO */
}

/*!
****************************************************************************************************
* 功能描述：该方法用于设置指定通道输出指定的电流值
* 注意事项：NA
* 输入参数：idx -- DAC驱动标识
*           mA  -- 期望输出的电流值，单位mA
* 输出参数：NA
* 返回参数：NA
****************************************************************************************************
*/
void DRVMGR_DACSetOutputCurrent(int idx, float mA)
{
	uint8_t	 cmd;
	float	 mV;
	uint16_t data;
	uint8_t	 tx[3];

	// 选择命令字
	switch (idx) {
		case DRVID_DAC_1:
			cmd = DAC_CMD_CH_A;
			break;
		case DRVID_DAC_2:
			cmd = DAC_CMD_CH_B;
			break;
		default:
			return;
	}

	// 计算需输出的电压
	mV	 = mA * SAMPLE_R;
	data = mV * DAC_RESOLUTION / VREFIN;
	if (data >= DAC_RESOLUTION) {
		data = DAC_RESOLUTION;
	}
	else if (data < 0) {
		data = 0;
	}
	
	tx[0] = cmd;
	tx[1] = (uint8_t)(data >> 8);
	tx[2] = (uint8_t)(data & 0xFF);

	// 片选DAC
	DRVMGR_SPISelectChip(DRVID_SPI_2_CS_DAC);
	
	// 片选建立时间，确保DAC识别到片选信号
	DRVMGR_TimerDelayUs(10); 

	// 发送3字节数据
	DRVMGR_SPISendBytes(DRVID_SPI_2, tx, 3);
	
	// 数据发送后延时，确保DAC采样完成
	DRVMGR_TimerDelayUs(10); 

	// 释放片选
	DRVMGR_SPISelectChip(DRVID_SPI_2_CS_NONE);
}
